rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES DE AYUDA ---
    
    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica si el usuario es dueño del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Verifica si el usuario tiene un rol específico de forma segura
    function hasRole(role) {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isAuthenticated() && exists(userPath) && get(userPath).data.get('role', 'none') == role;
    }

    // Verifica si el usuario tiene rol de administrador
    function isAdmin() {
      return hasRole('admin');
    }

    // Verifica si el usuario tiene rol de profesor
    function isTeacher() {
      return hasRole('teacher');
    }

    // --- REGLAS DE COLECCIONES ---

    // Usuarios: Solo el dueño o un admin pueden leer/escribir.
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId) || isAdmin();
    }

    // Transacciones y Finanzas: Solo el dueño o un admin pueden ver.
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.amount is number;
      allow update, delete: if isAdmin();
    }

    // Resultados de Simulacros: Dueño, su Profesor de clase o Admin pueden leer.
    match /results/{resultId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isTeacher() || isAdmin());
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.score is number;
      allow update, delete: if isAdmin();
    }

    // Clases / Aulas: Solo el profesor dueño o un admin gestionan.
    match /classrooms/{classId} {
      allow read: if isAuthenticated();
      allow create: if isTeacher() || isAdmin();
      allow update, delete: if isAdmin() || (isTeacher() && resource.data.teacherId == request.auth.uid);
    }

    // Exámenes / Tareas asignadas
    match /assignments/{assignmentId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // Miembros de Clase: Solo Profesores y Admins gestionan. Alumnos leen su pertenencia.
    match /class_members/{memberId} {
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isTeacher() || isAdmin());
      allow write: if isTeacher() || isAdmin();
    }

    // Preguntas: Lectura pública, escritura solo Admin.
    match /questions/{questionId} {
      allow read: if isAuthenticated(); 
      allow write: if isAdmin();
    }

    // Configuración del Sistema: Lectura pública, escritura Admin.
    match /system/{configId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Denegación por defecto para cualquier otra ruta
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
